{% load fr_display %}
{% if request.user.is_authenticated %}

{% active_shelf book as active_shelf %}
<div class="field is-grouped">
    {% with book.id|uuid as uuid %}
    {% if active_shelf.identifier == 'read' %}
    <button class="button is-small" disabled>
        <span>Read</span> <span class="icon icon-check"></span>
    </button>
    {% elif active_shelf.identifier == 'reading' %}
    <label class="button is-small" for="finish-reading-{{ uuid }}" role="button" tabindex="0">
        I'm done!
    </label>
    {% include 'snippets/finish_reading_modal.html' %}
    {% elif active_shelf.identifier == 'to-read' %}
    <label class="button is-small" for="start-reading-{{ uuid }}" role="button" tabindex="0">
        Start reading
    </label>
    {% include 'snippets/start_reading_modal.html' %}
    {% else %}
    <form name="shelve" action="/shelve/" method="post">
        {% csrf_token %}
        <input type="hidden" name="book" value="{{ book.id }}">
        <input type="hidden" name="shelf" value="to-read">
        <button class="button is-small" type="submit">Want to read</button>
    </form>
    {% endif %}
    {% endwith %}

    <div class="dropdown is-hoverable">
        <div class="dropdown-trigger">
            <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu-{{ uuid }}">
                <span class="icon icon-arrow-down"><span class="is-sr-only">More shelves</span></span>
            </button>
        </div>

        {% with book.id|uuid as uuid %}
        <div class="dropdown-menu" id="dropdown-menu-{{ uuid }}" role="menu">
            <ul class="dropdown-content">
                {% for shelf in request.user.shelf_set.all %}
                <li>
                    {% if shelf.identifier == 'to-read' %}
                    <div class="dropdown-item pt-0 pb-0">
                        <label class="button is-small" for="start-reading-{{ uuid }}" role="button" tabindex="0">
                            Start reading
                        </label>
                        {% include 'snippets/start_reading_modal.html' %}
                    </div>
                    {% else %}
                    <form class="dropdown-item pt-0 pb-0" name="shelve" action="/shelve/" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="book" value="{{ book.id }}">
                        <button class="button is-small" name="shelf" type="submit" value="{{ shelf.identifier }}" {% if shelf in book.shelf_set.all %} disabled {% endif %}>
                            <span>{{ shelf.name }}</span>
                            {% if shelf in book.shelf_set.all %}<span class="icon icon-check"></span>{% endif %}
                        </button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endwith %}
    </div>
</div>

{% endif %}
